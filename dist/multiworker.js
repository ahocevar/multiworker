(function(_,w){typeof exports=="object"&&typeof module!="undefined"?module.exports=w():typeof define=="function"&&define.amd?define(w):(_=typeof globalThis!="undefined"?globalThis:_||self,_.MultiWorker=w())})(this,function(){"use strict";var _=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function w(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var E={exports:{}};(function(a,r){var i=typeof self!="undefined"?self:_,o=function(){function h(){this.fetch=!1,this.DOMException=i.DOMException}return h.prototype=i,new h}();(function(h){(function(d){var p={searchParams:"URLSearchParams"in h,iterable:"Symbol"in h&&"iterator"in Symbol,blob:"FileReader"in h&&"Blob"in h&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in h,arrayBuffer:"ArrayBuffer"in h};function z(e){return e&&DataView.prototype.isPrototypeOf(e)}if(p.arrayBuffer)var G=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],V=ArrayBuffer.isView||function(e){return e&&G.indexOf(Object.prototype.toString.call(e))>-1};function m(e){if(typeof e!="string"&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function k(e){return typeof e!="string"&&(e=String(e)),e}function B(e){var t={next:function(){var s=e.shift();return{done:s===void 0,value:s}}};return p.iterable&&(t[Symbol.iterator]=function(){return t}),t}function f(e){this.map={},e instanceof f?e.forEach(function(t,s){this.append(s,t)},this):Array.isArray(e)?e.forEach(function(t){this.append(t[0],t[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}f.prototype.append=function(e,t){e=m(e),t=k(t);var s=this.map[e];this.map[e]=s?s+", "+t:t},f.prototype.delete=function(e){delete this.map[m(e)]},f.prototype.get=function(e){return e=m(e),this.has(e)?this.map[e]:null},f.prototype.has=function(e){return this.map.hasOwnProperty(m(e))},f.prototype.set=function(e,t){this.map[m(e)]=k(t)},f.prototype.forEach=function(e,t){for(var s in this.map)this.map.hasOwnProperty(s)&&e.call(t,this.map[s],s,this)},f.prototype.keys=function(){var e=[];return this.forEach(function(t,s){e.push(s)}),B(e)},f.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),B(e)},f.prototype.entries=function(){var e=[];return this.forEach(function(t,s){e.push([s,t])}),B(e)},p.iterable&&(f.prototype[Symbol.iterator]=f.prototype.entries);function A(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function D(e){return new Promise(function(t,s){e.onload=function(){t(e.result)},e.onerror=function(){s(e.error)}})}function $(e){var t=new FileReader,s=D(t);return t.readAsArrayBuffer(e),s}function Q(e){var t=new FileReader,s=D(t);return t.readAsText(e),s}function X(e){for(var t=new Uint8Array(e),s=new Array(t.length),c=0;c<t.length;c++)s[c]=String.fromCharCode(t[c]);return s.join("")}function x(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function S(){return this.bodyUsed=!1,this._initBody=function(e){this._bodyInit=e,e?typeof e=="string"?this._bodyText=e:p.blob&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:p.formData&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:p.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():p.arrayBuffer&&p.blob&&z(e)?(this._bodyArrayBuffer=x(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):p.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(e)||V(e))?this._bodyArrayBuffer=x(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||(typeof e=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):p.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},p.blob&&(this.blob=function(){var e=A(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?A(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then($)}),this.text=function(){var e=A(this);if(e)return e;if(this._bodyBlob)return Q(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(X(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},p.formData&&(this.formData=function(){return this.text().then(Y)}),this.json=function(){return this.text().then(JSON.parse)},this}var J=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function K(e){var t=e.toUpperCase();return J.indexOf(t)>-1?t:e}function b(e,t){t=t||{};var s=t.body;if(e instanceof b){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new f(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,!s&&e._bodyInit!=null&&(s=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",(t.headers||!this.headers)&&(this.headers=new f(t.headers)),this.method=K(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&s)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(s)}b.prototype.clone=function(){return new b(this,{body:this._bodyInit})};function Y(e){var t=new FormData;return e.trim().split("&").forEach(function(s){if(s){var c=s.split("="),u=c.shift().replace(/\+/g," "),n=c.join("=").replace(/\+/g," ");t.append(decodeURIComponent(u),decodeURIComponent(n))}}),t}function Z(e){var t=new f,s=e.replace(/\r?\n[\t ]+/g," ");return s.split(/\r?\n/).forEach(function(c){var u=c.split(":"),n=u.shift().trim();if(n){var v=u.join(":").trim();t.append(n,v)}}),t}S.call(b.prototype);function y(e,t){t||(t={}),this.type="default",this.status=t.status===void 0?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new f(t.headers),this.url=t.url||"",this._initBody(e)}S.call(y.prototype),y.prototype.clone=function(){return new y(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})},y.error=function(){var e=new y(null,{status:0,statusText:""});return e.type="error",e};var ee=[301,302,303,307,308];y.redirect=function(e,t){if(ee.indexOf(t)===-1)throw new RangeError("Invalid status code");return new y(null,{status:t,headers:{location:e}})},d.DOMException=h.DOMException;try{new d.DOMException}catch{d.DOMException=function(t,s){this.message=t,this.name=s;var c=Error(t);this.stack=c.stack},d.DOMException.prototype=Object.create(Error.prototype),d.DOMException.prototype.constructor=d.DOMException}function T(e,t){return new Promise(function(s,c){var u=new b(e,t);if(u.signal&&u.signal.aborted)return c(new d.DOMException("Aborted","AbortError"));var n=new XMLHttpRequest;function v(){n.abort()}n.onload=function(){var g={status:n.status,statusText:n.statusText,headers:Z(n.getAllResponseHeaders()||"")};g.url="responseURL"in n?n.responseURL:g.headers.get("X-Request-URL");var O="response"in n?n.response:n.responseText;s(new y(O,g))},n.onerror=function(){c(new TypeError("Network request failed"))},n.ontimeout=function(){c(new TypeError("Network request failed"))},n.onabort=function(){c(new d.DOMException("Aborted","AbortError"))},n.open(u.method,u.url,!0),u.credentials==="include"?n.withCredentials=!0:u.credentials==="omit"&&(n.withCredentials=!1),"responseType"in n&&p.blob&&(n.responseType="blob"),u.headers.forEach(function(g,O){n.setRequestHeader(O,g)}),u.signal&&(u.signal.addEventListener("abort",v),n.onreadystatechange=function(){n.readyState===4&&u.signal.removeEventListener("abort",v)}),n.send(typeof u._bodyInit=="undefined"?null:u._bodyInit)})}return T.polyfill=!0,h.fetch||(h.fetch=T,h.Headers=f,h.Request=b,h.Response=y),d.Headers=f,d.Request=b,d.Response=y,d.fetch=T,Object.defineProperty(d,"__esModule",{value:!0}),d})({})})(o),o.fetch.ponyfill=!0,delete o.fetch.polyfill;var l=o;r=l.fetch,r.default=l.fetch,r.fetch=l.fetch,r.Headers=l.Headers,r.Request=l.Request,r.Response=l.Response,a.exports=r})(E,E.exports);var U=w(E.exports);function R(a){return`(${a.toString()})();`}function M(a){return a.reduce((r,i)=>`${r+i.toString()};`,"")}function F(){}function j(a,r){U(a).then(i=>i.text()).then(r).catch(i=>{a.startsWith("file://")&&(a=a.substr(7)),Promise.resolve().then(function(){return N}).then(o=>{o.readFile(a,"utf8",(l,h)=>{if(l)throw l;r(h)})}).catch(o=>{throw o})})}let L=0;class C{constructor(){this.id=L++,this.done=!1}}class I{constructor(r,i,o){this.event=o,this.done=!!i.done,this.instance=r}}var q=`(function () {
  (function () {
    let currentPost;

    function _sendPost() {
      let args = Array.prototype.slice.call(arguments);
      currentPost.done = args.shift();
      args.push(currentPost);
      postMessage(args);
    }

    self.return = _sendPost.bind(this, true);
    self.post = _sendPost.bind(this, false);

    self.addEventListener('message', function (e) {
      currentPost = e.data.pop();
      self.receive.apply(e, e.data);
    }, false);
  }());

  '__MultiWorker_placeholder__';
})();`;const P=new WeakMap;class W{constructor(r){const i=r.worker!==void 0?r.worker:r;typeof i=="string"?j(i,o=>{this.worker=o,this._init()}):typeof i=="function"&&(this.worker=R(i)),this.callback=r.callback||F,this.threads=r.threads||1,this.dependencies=r.dependencies||[],this._initProperties(),this.worker&&this._init()}post(...r){const i=typeof r[r.length-1]=="function"?r.pop():this.callback;return this._process(r,i),this}terminate(r=!1,i){return typeof r=="function"&&(i=r,r=!1),r||this.ready&&!this.processCount?(this.workerList.forEach(o=>o.terminate()),this._initProperties(),this.threads=0,delete this.terminateWhenFree,typeof i=="function"&&i()):this.terminateWhenFree=i||!0,this}_init(){this.ready=!0,this._initThreads(),this._processQueue()}_process(r,i){const o=this._availableWorker,l=new C;r.push(l),this.ready&&o?(this._inProgressData[l.id]={cb:i,worker:o},o.postMessage(r),P.set(o,!0),this.processCount++):this.queue.push([r,i])}_initProperties(){this.ready=!1,this.workerList=[],this.queue=[],this.processCount=0,this._inProgressData={}}_initThreads(){let r=this.threads;for(;r--;){const i=new Worker(this._blobUrl);i.addEventListener("message",this.constructor._defaultMessageEvent.bind(this),!1),this.workerList.push(i)}}static _defaultMessageEvent(r){const i=r.data.pop(),{cb:o}=this._inProgressData[i.id],l=new I(this,i,r);i.done&&this._processFinished(i.id),o.apply(l,r.data),i.done&&this._processQueue()}_processFinished(r){this.processCount--;const{worker:i}=this._inProgressData[r];return P.set(i,!1),delete this._inProgressData[r],this}_processQueue(){if(this.queue.length&&this.processCount<this.threads){const r=this.queue.shift();this._process(...r),this._processQueue()}else this.terminateWhenFree&&!this.processCount&&this.terminate(!0,this.terminateWhenFree);return this}get _availableWorker(){const r=this.workerList;for(let i=0,o=r.length;i<o;i++)if(!P.get(r[i]))return r[i];return!1}get _workerString(){return q.replace("'__MultiWorker_placeholder__';",this._dependencyString+this.worker)}get _blobUrl(){return this._blobUrlCached||(this._blobUrlCached=typeof Blob=="undefined"?`data:text/javascript;base64,${Buffer.from(this._workerString,"binary").toString("base64")}`:URL.createObjectURL(new Blob([this._workerString],{type:"application/javascript"}))),this._blobUrlCached}get _dependencyString(){return M(this.dependencies)}}var H={},N=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:H});return W});
//# sourceMappingURL=multiworker.js.map
